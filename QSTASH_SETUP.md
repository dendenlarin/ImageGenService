# QStash Setup Guide

Этот проект использует [Upstash QStash](https://upstash.com/docs/qstash) для управления очередями генерации изображений с rate limiting.

## Что такое QStash?

QStash - это HTTP-based messaging и scheduling сервис для serverless и edge приложений. Он позволяет:
- Ставить задачи в очередь с delay
- Автоматически повторять попытки при ошибках
- Управлять rate limiting
- Гарантировать доставку сообщений

## Зачем нужен QStash?

В ImageGenService QStash решает следующие проблемы:

1. **Rate Limiting**: API Gemini Imagen имеет ограничения на количество запросов в час. QStash позволяет автоматически распределять задачи с нужными интервалами.

2. **Надежность**: Если генерация изображения не удалась из-за временной ошибки, QStash автоматически повторит попытку.

3. **Асинхронная обработка**: Генерация изображений происходит в фоне, не блокируя UI.

4. **Serverless-friendly**: QStash работает отлично с Vercel serverless функциями.

## Настройка QStash

### 1. Создайте аккаунт в Upstash

1. Перейдите на [upstash.com](https://upstash.com/)
2. Зарегистрируйтесь или войдите в аккаунт
3. Перейдите в раздел **QStash**

### 2. Получите QStash токен

1. В панели QStash найдите раздел **API Tokens**
2. Скопируйте ваш **QSTASH_TOKEN**
3. Этот токен понадобится для настройки приложения

### 3. Настройте приложение

1. Откройте приложение в браузере
2. Перейдите в **Настройки**
3. В разделе **API Ключи** вставьте ваш QStash токен в поле **QStash Token**
4. Также убедитесь, что настроены:
   - **OpenAI API Key** (для генерации параметров)
   - **Gemini API Key** (для генерации изображений)
5. Нажмите **Сохранить настройки**

### 4. Настройка в Vercel (для production)

При деплое на Vercel, добавьте следующие environment variables:

```bash
QSTASH_TOKEN=your_qstash_token_here
```

Также убедитесь, что переменная `VERCEL_URL` доступна (Vercel предоставляет её автоматически).

## Как это работает?

### Архитектура

```
1. Пользователь нажимает "Запустить"
   ↓
2. Клиент отправляет все pending задачи в QStash с delay
   ↓
3. QStash ставит задачи в очередь с указанными интервалами
   ↓
4. QStash вызывает webhook /api/process-generation-task для каждой задачи
   ↓
5. Webhook генерирует изображение и сохраняет результат
   ↓
6. Клиент делает polling /api/task-results для получения результатов
   ↓
7. Результаты отображаются в UI
```

### Rate Limiting

Rate limit настраивается в форме создания генерации (например, 60 запросов/час).

При отправке задач в QStash вычисляется delay между задачами:
```
delaySeconds = (60 * 60) / rateLimit
```

Например, для 60 запросов/час:
- delay = 3600 / 60 = 60 секунд между запросами

### Повторные попытки

QStash автоматически повторяет попытки при временных ошибках (HTTP 5xx).
Количество попыток настраивается в параметре `Upstash-Retries` (по умолчанию 3).

## Мониторинг

Вы можете отслеживать задачи в QStash Dashboard:

1. Откройте [console.upstash.com](https://console.upstash.com/)
2. Перейдите в **QStash > Messages**
3. Здесь вы увидите все активные и завершенные задачи

## Разработка без QStash

Для локальной разработки без QStash:

1. Оставьте поле QStash Token пустым в настройках
2. Приложение покажет предупреждение при попытке запустить генерацию
3. Вы можете использовать старую версию с локальной обработкой (см. git history)

## Troubleshooting

### Задачи не обрабатываются

1. Проверьте QStash токен в настройках
2. Проверьте логи в Vercel Dashboard
3. Убедитесь, что webhook URL доступен публично

### Ошибки rate limit

Если вы видите ошибки "Rate limit exceeded":
1. Увеличьте интервал между запросами (уменьшите rate limit)
2. Проверьте лимиты вашего Gemini API аккаунта

### Задачи застряли в статусе "processing"

1. Проверьте логи QStash Dashboard
2. Проверьте логи webhook endpoint в Vercel
3. Возможно, webhook не смог сохранить результат - проверьте `/api/task-results`

## Дополнительные ресурсы

- [QStash Documentation](https://upstash.com/docs/qstash)
- [QStash API Reference](https://upstash.com/docs/qstash/api/messages/create)
- [Vercel Deployment Guide](https://vercel.com/docs)
